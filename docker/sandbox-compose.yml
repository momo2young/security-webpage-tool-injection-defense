# Microsandbox Server
# Separate from main docker-compose due to special requirements (privileged, host network, KVM)

services:
  microsandbox:
    container_name: suzent-microsandbox
    image: rust:1.83-bookworm
    privileged: true
    network_mode: host  # Required for microVM portal communication
    # NOTE: When using Windows + WSL2, you must use WSL2's IP address
    # Run 'wsl hostname -I' to get it, then set in config/default.yaml:
    # sandbox_server_url: "http://172.x.x.x:7263"
    devices:
      - /dev/kvm:/dev/kvm  # Required for microVM support
    volumes:
      - microsandbox-data:/root/.local/share/microsandbox
      - microsandbox-config:/root/.config/microsandbox
      - ..:/workspace  # Mount suzent root for session persistence
      # mount custom volumes here e.g.:
      # - D:/data:/mnt/d/data
    working_dir: /workspace
    environment:
      - RUST_LOG=${RUST_LOG:-info}
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq curl git build-essential libssl-dev pkg-config &&
        curl -sSL https://raw.githubusercontent.com/zerocore-ai/microsandbox/refs/heads/main/scripts/install_microsandbox.sh | sh &&
        export PATH=\"$$HOME/.local/bin:$$PATH\" &&
        msb server start --host 0.0.0.0 --port 7263 --dev
      "
    restart: unless-stopped

volumes:
  microsandbox-data:
    driver: local
  microsandbox-config:
    driver: local
